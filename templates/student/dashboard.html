{% extends "base.html" %}

{% block title %}Student Dashboard - AI Grading System{% endblock %}

{% block navbar_items %}
<li class="nav-item">
    <a class="nav-link active" href="/student-dashboard">
        <i class="fas fa-tachometer-alt"></i> Dashboard
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/code-editor">
        <i class="fas fa-code"></i> Code Editor
    </a>
</li>
{% endblock %}

{% block user_menu %}
<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
        <i class="fas fa-user"></i> <span id="username">Student</span>
    </a>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#"><i class="fas fa-user-cog"></i> Profile</a></li>
        <li><a class="dropdown-item" href="#"><i class="fas fa-cog"></i> Settings</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
</li>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Welcome Section -->
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="text-gradient mb-2">Welcome back, <span id="welcomeUsername">Student</span>!</h2>
                        <p class="text-muted mb-0">Here's your academic progress overview</p>
                    </div>
                    <div class="text-end">
                        <div class="small text-muted">Last login</div>
                        <div class="fw-bold" id="lastLogin">Today</div>
                    </div>
                </div>
                
                <!-- Statistics Cards -->
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="stat-card bg-primary text-white">
                            <div class="stat-number" id="totalAssignments">0</div>
                            <div>Total Assignments</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card bg-success text-white">
                            <div class="stat-number" id="completedAssignments">0</div>
                            <div>Completed</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card bg-info text-white">
                            <div class="stat-number" id="averageScore">0%</div>
                            <div>Average Score</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card bg-warning text-white">
                            <div class="stat-number" id="plagiarismClear">0</div>
                            <div>Plagiarism Clear</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Assignments Section -->
            <div class="dashboard-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4><i class="fas fa-tasks"></i> Assignments</h4>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" id="refreshAssignments">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <select class="form-select form-select-sm" id="assignmentFilter" style="width: auto;">
                            <option value="all">All Assignments</option>
                            <option value="pending">Pending</option>
                            <option value="submitted">Submitted</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                </div>
                
                <div id="assignmentsList" class="row g-3">
                    <!-- Assignments will be loaded here -->
                </div>
                
                <div id="noAssignments" class="text-center py-5" style="display: none;">
                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No assignments found</h5>
                    <p class="text-muted">Check back later for new assignments from your instructors.</p>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Recent Submissions -->
            <div class="dashboard-card">
                <h5><i class="fas fa-history"></i> Recent Submissions</h5>
                <div id="recentSubmissions">
                    <!-- Recent submissions will be loaded here -->
                </div>
                
                <div id="noSubmissions" class="text-center py-3" style="display: none;">
                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-0">No submissions yet</p>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="dashboard-card">
                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                <div class="d-grid gap-2">
                    <a href="/code-editor" class="btn btn-primary">
                        <i class="fas fa-code"></i> Open Code Editor
                    </a>
                    <button class="btn btn-outline-info" id="viewProgress">
                        <i class="fas fa-chart-line"></i> View Progress
                    </button>
                    <button class="btn btn-outline-secondary" id="downloadReports">
                        <i class="fas fa-download"></i> Download Reports
                    </button>
                </div>
            </div>
            
            <!-- Upcoming Deadlines -->
            <div class="dashboard-card">
                <h5><i class="fas fa-clock"></i> Upcoming Deadlines</h5>
                <div id="upcomingDeadlines">
                    <!-- Deadlines will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assignment Detail Modal -->
<div class="modal fade" id="assignmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignmentModalTitle">Assignment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="assignmentModalBody">
                <!-- Assignment details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="startAssignmentBtn">
                    <i class="fas fa-play"></i> Start Assignment
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    if (!App.currentUser || App.currentUser.role !== 'student') {
        window.location.href = '/login';
        return;
    }
    
    loadDashboardData();
    setupEventListeners();
});

function loadDashboardData() {
    App.showLoading();
    
    App.API.get('/api/student/dashboard', function(data) {
        App.hideLoading();
        updateUserInfo(data.user);
        updateStatistics(data.statistics);
        loadAssignments(data.assignments);
        loadRecentSubmissions(data.recent_submissions);
        loadUpcomingDeadlines(data.assignments);
    }, function(xhr) {
        App.hideLoading();
        App.showAlert('Failed to load dashboard data', 'danger');
    });
}

function updateUserInfo(user) {
    $('#username').text(user.username);
    $('#welcomeUsername').text(user.username);
    $('#lastLogin').text(App.formatDate(user.created_at));
}

function updateStatistics(stats) {
    $('#totalAssignments').text(stats.total_assignments);
    $('#completedAssignments').text(stats.completed_assignments);
    $('#averageScore').text(Math.round(stats.average_score) + '%');
    $('#plagiarismClear').text(stats.plagiarism_clear);
}

function loadAssignments(assignments) {
    const container = $('#assignmentsList');
    container.empty();
    
    if (assignments.length === 0) {
        $('#noAssignments').show();
        return;
    }
    
    assignments.forEach(assignment => {
        const assignmentCard = createAssignmentCard(assignment);
        container.append(assignmentCard);
    });
}

function createAssignmentCard(assignment) {
    const statusBadge = getStatusBadge(assignment);
    const timeRemaining = App.formatTimeRemaining(assignment.deadline);
    const difficultyBadge = App.getDifficultyBadge(assignment.difficulty);
    
    return `
        <div class="col-12">
            <div class="card assignment-card ${getAssignmentClass(assignment)}" data-assignment-id="${assignment._id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-2">
                                ${assignment.title}
                                ${difficultyBadge}
                            </h6>
                            <p class="card-text text-muted small mb-2">${assignment.description.substring(0, 100)}...</p>
                            <div class="d-flex align-items-center gap-3 small text-muted">
                                <span><i class="fas fa-calendar"></i> Due: ${new Date(assignment.deadline).toLocaleDateString()}</span>
                                <span><i class="fas fa-clock"></i> ${timeRemaining}</span>
                                <span><i class="fas fa-code"></i> ${assignment.programming_language}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            ${statusBadge}
                            ${assignment.score !== null ? `<div class="mt-1 small">Score: ${assignment.score}%</div>` : ''}
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary view-assignment" data-assignment-id="${assignment._id}">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                        ${assignment.submission_status === 'pending' ? 
                            `<a href="/code-editor?assignment=${assignment._id}" class="btn btn-sm btn-primary">
                                <i class="fas fa-play"></i> Start
                            </a>` : 
                            `<button class="btn btn-sm btn-success" disabled>
                                <i class="fas fa-check"></i> Submitted
                            </button>`
                        }
                    </div>
                </div>
            </div>
        </div>
    `;
}

function getStatusBadge(assignment) {
    if (assignment.submission_status === 'submitted') {
        return '<span class="badge bg-success">Submitted</span>';
    } else if (new Date(assignment.deadline) < new Date()) {
        return '<span class="badge bg-danger">Overdue</span>';
    } else {
        return '<span class="badge bg-warning">Pending</span>';
    }
}

function getAssignmentClass(assignment) {
    if (assignment.submission_status === 'submitted') {
        return 'submitted';
    } else if (new Date(assignment.deadline) < new Date()) {
        return 'overdue';
    }
    return '';
}

function loadRecentSubmissions(submissions) {
    const container = $('#recentSubmissions');
    container.empty();
    
    if (submissions.length === 0) {
        $('#noSubmissions').show();
        return;
    }
    
    submissions.forEach(submission => {
        const submissionItem = `
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <div class="fw-bold small">${submission.assignment_title}</div>
                    <div class="text-muted small">${App.formatDate(submission.submitted_at)}</div>
                </div>
                <div class="text-end">
                    <div class="fw-bold">${submission.score}%</div>
                    ${App.getPlagiarismStatus(submission.plagiarism_passed)}
                </div>
            </div>
        `;
        container.append(submissionItem);
    });
}

function loadUpcomingDeadlines(assignments) {
    const container = $('#upcomingDeadlines');
    container.empty();
    
    const upcoming = assignments
        .filter(a => a.submission_status === 'pending' && new Date(a.deadline) > new Date())
        .sort((a, b) => new Date(a.deadline) - new Date(b.deadline))
        .slice(0, 5);
    
    if (upcoming.length === 0) {
        container.html('<p class="text-muted small">No upcoming deadlines</p>');
        return;
    }
    
    upcoming.forEach(assignment => {
        const deadline = `
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <div class="fw-bold small">${assignment.title}</div>
                    <div class="text-muted small">${App.formatTimeRemaining(assignment.deadline)}</div>
                </div>
                <div>
                    ${App.getDifficultyBadge(assignment.difficulty)}
                </div>
            </div>
        `;
        container.append(deadline);
    });
}

function setupEventListeners() {
    // Refresh assignments
    $('#refreshAssignments').click(function() {
        loadDashboardData();
    });
    
    // Assignment filter
    $('#assignmentFilter').change(function() {
        const filter = $(this).val();
        filterAssignments(filter);
    });
    
    // View assignment details
    $(document).on('click', '.view-assignment', function() {
        const assignmentId = $(this).data('assignment-id');
        viewAssignmentDetails(assignmentId);
    });
    
    // Quick actions
    $('#viewProgress').click(function() {
        // Implement progress view
        App.showAlert('Progress view coming soon!', 'info');
    });
    
    $('#downloadReports').click(function() {
        // Implement report download
        App.showAlert('Report download coming soon!', 'info');
    });
}

function filterAssignments(filter) {
    $('.assignment-card').each(function() {
        const card = $(this);
        const assignment = card.data('assignment-id');
        
        switch(filter) {
            case 'pending':
                card.toggle(!card.hasClass('submitted') && !card.hasClass('overdue'));
                break;
            case 'submitted':
                card.toggle(card.hasClass('submitted'));
                break;
            case 'overdue':
                card.toggle(card.hasClass('overdue'));
                break;
            default:
                card.show();
        }
    });
}

function viewAssignmentDetails(assignmentId) {
    App.API.get(`/api/assignments/${assignmentId}`, function(assignment) {
        const modalTitle = $('#assignmentModalTitle');
        const modalBody = $('#assignmentModalBody');
        const startBtn = $('#startAssignmentBtn');
        
        modalTitle.text(assignment.title);
        
        const detailsHtml = `
            <div class="row">
                <div class="col-md-8">
                    <h6>Description</h6>
                    <p>${assignment.description}</p>
                    
                    <h6>Requirements</h6>
                    <ul>
                        <li>Programming Language: <strong>${assignment.programming_language}</strong></li>
                        <li>Maximum Score: <strong>${assignment.max_score} points</strong></li>
                        <li>Difficulty: ${App.getDifficultyBadge(assignment.difficulty)}</li>
                    </ul>
                    
                    ${assignment.starter_code ? `
                        <h6>Starter Code</h6>
                        <pre class="bg-light p-3 rounded"><code>${assignment.starter_code}</code></pre>
                    ` : ''}
                </div>
                <div class="col-md-4">
                    <h6>Assignment Info</h6>
                    <div class="bg-light p-3 rounded">
                        <div class="mb-2"><strong>Deadline:</strong><br>${new Date(assignment.deadline).toLocaleString()}</div>
                        <div class="mb-2"><strong>Time Remaining:</strong><br>${App.formatTimeRemaining(assignment.deadline)}</div>
                        <div><strong>Test Cases:</strong><br>${assignment.test_cases.length} test cases</div>
                    </div>
                </div>
            </div>
        `;
        
        modalBody.html(detailsHtml);
        startBtn.attr('href', `/code-editor?assignment=${assignmentId}`);
        
        $('#assignmentModal').modal('show');
    });
}
</script>
{% endblock %}